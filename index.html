<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Role Permission SQL Generator</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #f5f5f5;
        padding: 20px;
      }

      label {
        font-weight: bold;
        color: #555;
      }

      input[type="text"],
      select {
        width: 250px;
      }

      input,
      select,
      textarea {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button.clear {
        background-color: #ffffff;
        border: 1px solid #ddd;
        color: black;
      }

      button.clear:hover {
        background-color: #f9f9f9;
      }

      button.delete {
        background-color: #dc3545;
      }

      button.delete:hover {
        background-color: #c82333;
      }

      .button-group {
        display: flex;
        padding-top: 12px;
        gap: 10px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 2px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);

        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .form-section {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;

        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .form-row {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      #pathInputFormGroup,
      #actionSelectFormGroup {
        display: none;
      }

      .entries-table {
        width: 100%;
        border-collapse: collapse;
      }

      .entries-table th,
      .entries-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }

      .entries-table th {
        background-color: #75b4f3;
        font-weight: bold;
      }

      .entries-table tr:hover {
        background-color: #f9f9f9;
      }

      .selected-row {
        background-color: #cfcfcf;
      }

      .output-area {
        width: 100%;
        height: 300px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Role Permission SQL Generator</h1>

      <div class="form-section">
        <h2>Base Configurations</h2>

        <div class="form-row">
          <div class="form-group">
            <label for="urlPrefixInput">URL Prefix:</label>
            <input
              type="text"
              id="urlPrefixInput"
              value="https://api-uat-intra.acp.aic.sg/"
            />
          </div>
          <div class="form-group">
            <label for="dbNameInput">Database Name:</label>
            <input type="text" id="dbNameInput" value="ACP_ADMIN_DB_PROD" />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3>Accessible Resource Entry</h3>

        <!-- First Row -->
        <div class="form-row">
          <div class="form-group">
            <label for="roleCodeSelect">Role Code:</label>
            <select id="roleCodeSelect">
              <option value="">Select a role...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="serviceTypeSelect">Function:</label>
            <select id="serviceTypeSelect">
              <option value="">Select a function...</option>
            </select>
          </div>
        </div>

        <!-- Second Row -->
        <div class="form-row">
          <div class="form-group">
            <label for="functionGroupInput">Function Group:</label>
            <input
              type="text"
              id="functionGroupInput"
              placeholder="Function Group"
            />
          </div>

          <div id="actionSelectFormGroup" class="form-group">
            <label for="actionSelect">Action:</label>
            <select id="actionSelect"></select>
          </div>
        </div>

        <!-- Third Row -->
        <div class="form-row">
          <div id="pathInputFormGroup" class="form-group">
            <label for="pathInput">Path:</label>
            <input type="text" id="pathInput" placeholder="Path" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>
              <input type="checkbox" id="createAccessibleResource" />
              Create Accessible Resource
            </label>
          </div>
        </div>

        <div class="button-group">
          <button onclick="addEntry()">Add Entry</button>
          <button class="clear" onclick="clearEntry()">Clear</button>
        </div>
      </div>

      <!-- Added Entries Section -->
      <div class="form-section">
        <h3>Added Entries</h3>
        <table class="entries-table" id="entriesTable">
          <thead>
            <tr>
              <th>Role Code</th>
              <th>FunctionGroup</th>
              <th>Function</th>
              <th>Action</th>
              <th>Path</th>
              <th>Create AR</th>
            </tr>
          </thead>
          <tbody id="entriesTableBody"></tbody>
        </table>
        <div class="button-group">
          <button class="delete" onclick="deleteSelectedEntries()">
            Delete Selected
          </button>
          <button onclick="generateSQL()">Generate SQL</button>
        </div>
      </div>

      <!-- Generate Section -->
      <div class="form-section">
        <h3>Generated SQL</h3>
        <textarea id="outputText" class="output-area" readonly></textarea>
      </div>
    </div>
    <script>
      class RolePermissionGenerator {
        constructor() {
          this.entries = [];
          this.services = ["user-org", "patient-form", "report"];
          this.roleCode = [
            "SYSTEM_ADMIN",
            "INSTITUTIONAL_ADMIN",
            "ENDORSING_OFFICER",
            "CLUSTER_REPRESENTATIVE",
            "VIEWER",
            "TRAINING_ADMIN",
            "IT_SUPPORT",
            "FACILITATOR",
            "COORDINATOR",
            "PPC_FACILITATOR",
            "TRANSCRIBER",
            "GENERAL_FACILITATOR",
          ].sort();
          this.selectedRowIndexes = new Set();

          this.loadRoleCodes();
          this.loadServices();
          this.setupServiceSelected();
          this.setupActionSelect();
          this.setupTableClickHandler();
        }

        loadRoleCodes() {
          const roleSelect = document.getElementById("roleCodeSelect");

          this.roleCode.forEach((role) => {
            const option = document.createElement("option");
            option.value = role;
            option.textContent = role;
            roleSelect.appendChild(option);
          });
        }

        loadServices() {
          const serviceSelect = document.getElementById("serviceTypeSelect");

          this.services.forEach((service) => {
            const option = document.createElement("option");
            option.value = service;
            option.textContent = service;
            serviceSelect.appendChild(option);
          });
        }

        setupServiceSelected() {
          const serviceSelect = document.getElementById("serviceTypeSelect");
          const actionSelect = document.getElementById("actionSelect");
          const functionGroupInput =
            document.getElementById("functionGroupInput");
          const actionSelectFormGroup = document.getElementById(
            "actionSelectFormGroup"
          );
          const pathInputFormGroup =
            document.getElementById("pathInputFormGroup");

          const serviceActions = {
            report: ["create", "read", "update", "delete"],
            default: [
              "create",
              "read",
              "update",
              "delete",
              "execute",
              "search",
            ],
          };

          const createDefaultOption = () => {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "Select action...";
            return option;
          };

          actionSelect.appendChild(createDefaultOption());

          serviceSelect.addEventListener("change", (event) => {
            const selectedService = event.target.value;

            if (!selectedService) {
              this.hideFormGroup(actionSelectFormGroup);
              this.hideFormGroup(pathInputFormGroup);
              return;
            }

            const actions =
              serviceActions[selectedService] || serviceActions.default;

            this.populateActionSelect(
              actionSelect,
              actions,
              createDefaultOption
            );

            // if selected service is report, disable functionGroup input and with a default value of Report
            if (selectedService === "report") {
              functionGroupInput.value = "Report";
              functionGroupInput.disabled = true;

              this.showFormGroup(pathInputFormGroup);
              pathInputFormGroup.querySelector("input").placeholder =
                "endpoint/someEndpoint";
            } else {
              functionGroupInput.value = "";
              functionGroupInput.placeholder = "Resource Type";
              functionGroupInput.disabled = false;

              this.hideFormGroup(pathInputFormGroup);
            }

            actionSelectFormGroup.style.display = "flex";
          });
        }

        setupActionSelect() {
          const actionSelect = document.getElementById("actionSelect");
          const pathInputFormGroup =
            document.getElementById("pathInputFormGroup");
          const pathInput = document.getElementById("pathInput");
          const serviceSelect = document.getElementById("serviceTypeSelect");

          actionSelect.addEventListener("change", (event) => {
            const selectedAction = event.target.value;

            if (serviceSelect.value === "report") return;

            if (selectedAction === "execute") {
              this.showFormGroup(pathInputFormGroup);
              pathInput.placeholder = "ResourceType/$operation";
            } else {
              this.hideFormGroup(pathInputFormGroup);
            }
          });
        }

        setupTableClickHandler() {
          document
            .getElementById("entriesTableBody")
            .addEventListener("click", (e) => {
              const row = e.target.closest("tr");

              // If there is an entry
              if (row) {
                row.classList.toggle("selected-row");

                const rowIndex = Array.from(row.parentNode.children).indexOf(
                  row
                );

                if (this.selectedRowIndexes.has(rowIndex)) {
                  this.selectedRowIndexes.delete(rowIndex);
                } else {
                  this.selectedRowIndexes.add(rowIndex);
                }
              }
            });
        }

        // onClick Handlers =========================================================================
        addEntry() {
          const roleCode = document.getElementById("roleCodeSelect").value;
          const functionGroup = this.trimInput(
            document.getElementById("functionGroupInput").value
          );
          const functionName =
            document.getElementById("serviceTypeSelect").value;
          const action = document.getElementById("actionSelect").value;
          const path = this.trimInput(
            document.getElementById("pathInput").value
          );
          const createAccessibleResource = document.getElementById(
            "createAccessibleResource"
          ).checked;

          if (
            !this.validateRequiredFields(
              roleCode,
              functionGroup,
              functionName,
              action,
              path
            )
          ) {
            return alert("Please fill in all required fields.");
          }

          const entry = {
            roleCode,
            functionGroup,
            functionName,
            action: action === "search" ? "read" : action,
            path: this.generateEntryPath(
              action,
              path,
              functionGroup,
              functionName
            ),
            createAccessibleResource,
          };

          // TODO:
          // If createAccessibleResource is checked,
          // ensure no duplicate entries for the same functionGroup, functionName, action, path

          this.entries.push(entry);
          this.updateEntriesTable();
        }

        clearEntry() {
          document.getElementById("roleCodeSelect").value = "";
          document.getElementById("functionGroupInput").value = "";
          document.getElementById("serviceTypeSelect").value = "";
          document.getElementById("actionSelect").value = "";
          document.getElementById("pathInput").value = "";
          document.getElementById("createAccessibleResource").checked = false;

          // Hide action and path form groups
          this.hideFormGroup(document.getElementById("actionSelectFormGroup"));
          this.hideFormGroup(document.getElementById("pathInputFormGroup"));
        }

        deleteSelectedEntries() {
          if (this.selectedRowIndexes.size === 0) return;

          this.entries = this.entries.filter(
            (_, index) => !this.selectedRowIndexes.has(index)
          );
          this.updateEntriesTable();
          this.selectedRowIndexes.clear();
        }

        generateSQL() {
          if (this.entries.length === 0) {
            alert("No entries added yet");
            return "";
          }

          const urlPrefix =
            document.getElementById("urlPrefixInput").value.trim() ||
            "https://api-uat-intra.acp.aic.sg/";
          const dbName =
            document.getElementById("dbNameInput").value.trim() ||
            "ACP_ADMIN_DB_PROD";

          let sql = `USE [${dbName}]\nGO\n\n`;
          sql += "-- Declare Variables\n";

          // Declare role id variables
          const roleCodes = new Set();
          this.entries.forEach((entry) => {
            roleCodes.add(entry.roleCode);
          });

          roleCodes.forEach((roleCode) => {
            sql += `DECLARE @${roleCode.replace(
              /-/g,
              "_"
            )}RoleId nvarchar(64)\n`;
          });

          // Declare Accessible Resource Id variable
          sql += "DECLARE @AccessibleResourceId nvarchar(64)\n\n";

          // Set Role ids
          sql += "-- Set Role Ids\n";
          roleCodes.forEach((roleCode) => {
            sql += `SELECT @${roleCode.replace(
              /-/g,
              "_"
            )}RoleId = Id FROM dbo.[Role] WHERE Code = '${roleCode}'\n`;
          });

          sql += "\n";

          // Group entries by role
          // { SYSTEM_ADMIN: [entry1, entry2], INSTITUTIONAL_ADMIN: [entry3] }
          const roles = {};
          this.entries.forEach((entry) => {
            const role = entry.roleCode;
            if (!roles[role]) {
              roles[role] = [];
            }
            roles[role].push(entry);
          });

          // Generate SQL for each role
          Object.entries(roles).forEach(([roleCode, roleEntries]) => {
            sql += `-- Role: ${roleCode}\n`;

            // Generate SQL for each entry
            roleEntries.forEach((entry) => {
              // Create AccessibleResource if checkbox was selected
              if (entry.createAccessibleResource) {
                sql += `-- Create AccessibleResource for ${entry.path} - ${entry.action}\n`;
                sql += "INSERT INTO [dbo].[AccessibleResource] (\n";
                sql +=
                  "    [Id], [VersionId], [FunctionGroup], [Function], [Action], [Category], [Description], [Path], [ViewOrder],\n";
                sql +=
                  "    [Meta_LastUpdated], [CreatedBy], [CreationDateTime], [ModifiedBy], [ModificationDateTime], [IsDeleted]\n";
                sql += ") VALUES (\n";
                sql += "    NEWID(), 1,\n";
                sql += `    N'${entry.functionGroup}', N'${entry.functionName}', N'${entry.action}', N'api', N'${entry.functionGroup} ${entry.action} access', N'${entry.path}', 0,\n`;
                sql +=
                  "    NULL, N'A1C2D3E4-F5B6-47C8-9A01-2D3E4F5B6C78', GETUTCDATE(), N'A1C2D3E4-F5B6-47C8-9A01-2D3E4F5B6C78', GETUTCDATE(), 0\n";
                sql += ")\n";
                sql += `PRINT 'Created AccessibleResource for ${entry.path} - ${entry.action}'\n\n`;
              }

              sql += `-- Get Accessible Resource ID for ${entry.path} - ${entry.action}\n`;
              sql += `SELECT @AccessibleResourceId = Id FROM [dbo].[AccessibleResource] WHERE [FunctionGroup]='${entry.functionGroup}' `;
              sql += `AND [Function]='${entry.functionName}' AND [Action]='${entry.action}' AND [Path]='${entry.path}'\n\n`;

              sql += "IF @AccessibleResourceId IS NOT NULL\n";
              sql += "BEGIN\n";
              sql += "    INSERT INTO [dbo].[RolePermission] (\n";
              sql += "        [Id], [VersionId], \n";
              sql +=
                "        [Role_Reference], [Role_ReferenceResourceId], [Role_ReferenceResourceVersionId], [Role_ReferenceResourceType], [Role__exists], \n";
              sql +=
                "        [AccessibleResource_Reference], [AccessibleResource_ReferenceResourceId], [AccessibleResource_ReferenceResourceVersionId], [AccessibleResource_ReferenceResourceType], [AccessibleResource__exists], \n";
              sql +=
                "        [Meta_LastUpdated], [CreatedBy], [CreationDateTime], [ModifiedBy], [ModificationDateTime], [IsDeleted]\n";
              sql += "    )\n";
              sql += "    VALUES (\n";
              sql += "        NEWID(), 1, \n";
              sql += `        N'${urlPrefix}', @${roleCode.replace(
                /-/g,
                "_"
              )}RoleId, N'1', N'Role', 1, \n`;
              sql += `        N'${urlPrefix}', @AccessibleResourceId, N'1', N'AccessibleResource', 1, \n`;
              sql +=
                "        NULL, N'A1C2D3E4-F5B6-47C8-9A01-2D3E4F5B6C78', GETUTCDATE(), N'A1C2D3E4-F5B6-47C8-9A01-2D3E4F5B6C78', GETUTCDATE(), 0\n";
              sql += "    )\n";
              sql += `    PRINT 'Added permission for ${roleCode} to ${entry.path} - ${entry.action}'\n`;
              sql += "END\n";
              sql += "ELSE\n";
              sql += `    PRINT 'WARNING: Resource not found for ${entry.path} - ${entry.action}'\n\n`;
            });
          });

          document.getElementById("outputText").value = sql;
          return sql;
        }

        // Helper Functions =========================================================================
        showFormGroup(formGroup) {
          formGroup.style.display = "flex";
        }

        hideFormGroup(formGroup) {
          formGroup.style.display = "none";
        }

        populateActionSelect(selectElement, actions, createDefaultOption) {
          // Clear existing options
          selectElement.innerHTML = "";

          // Add default option
          selectElement.appendChild(createDefaultOption());

          // Add action options
          actions.forEach((action) => {
            const option = document.createElement("option");
            option.value = action;
            option.textContent = action;
            selectElement.appendChild(option);
          });
        }

        updateEntriesTable() {
          const tbody = document.getElementById("entriesTableBody");
          tbody.innerHTML = "";

          this.entries.forEach((entry, index) => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = entry.roleCode;
            row.insertCell(1).textContent = entry.functionGroup;
            row.insertCell(2).textContent = entry.functionName;
            row.insertCell(3).textContent = entry.action;
            row.insertCell(4).textContent = entry.path;
            row.insertCell(5).textContent = entry.createAccessibleResource
              ? "Yes"
              : "No";
          });
        }

        // Trim leading and trailing whitespace
        // Trim '/' from the start of the string
        trimInput(inputString) {
          return inputString.trim().replace(/^\/+/, "");
        }

        validateRequiredFields(
          roleCode,
          functionGroup,
          functionName,
          action,
          path
        ) {
          if (!roleCode || !functionGroup || !functionName || !action) {
            return false;
          }

          // Path value must have a value if action is execute or service is report
          if ((action === "execute" || functionName === "report") && !path) {
            return false;
          }

          return true;
        }

        generateEntryPath(action, path, functionGroup, functionName) {
          const isFhirService =
            functionName === "user-org" || functionName === "patient-form";

          if (!isFhirService) return path;

          if (action === "execute") return path;

          if (action === "search") return `${functionGroup}/_search`;

          return functionGroup;
        }
      }

      let app;

      window.onload = function () {
        app = new RolePermissionGenerator();
      };

      addEntry = function () {
        app.addEntry();
      };

      clearEntry = function () {
        app.clearEntry();
      };

      deleteSelectedEntries = function () {
        app.deleteSelectedEntries();
      };

      generateSQL = function () {
        app.generateSQL();
      };
    </script>
  </body>
</html>
